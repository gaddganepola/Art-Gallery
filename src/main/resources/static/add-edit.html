<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add / Edit Artwork</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .container {
          max-width: 650px;
        }

        .preview-image {
          width: 100%;
          max-width: 500px;
          max-height: 400px;
          object-fit: cover;
          border-radius: 10px;
          margin-bottom: 15px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>

<div class="container my-5">
    <h2 class="mb-4 text-center" id="formTitle">Add Artwork</h2>

    <form id="artworkForm">
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" id="title" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Artist</label>
            <input type="text" class="form-control" id="artist" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Medium</label>
            <input type="text" class="form-control" id="medium" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Year</label>
            <input type="number" class="form-control" id="year" required>
        </div>

        <!-- Image Preview -->
        <div class="mb-3 text-center" id="imagePreviewContainer">
            <label class="form-label">Image Preview</label>
            <img id="imagePreview" class="preview-image" alt="Preview">
        </div>

        <!-- File input -->
        <div class="mb-3">
            <label class="form-label">Upload Image</label>
            <input type="file" class="form-control" id="imageFile" accept="image/*">
        </div>

        <button type="submit" class="btn btn-success w-100">Save Artwork</button>
    </form>
</div>

<script>
    const API_URL = "http://localhost:8080/api"; // Change if needed
    const params = new URLSearchParams(window.location.search);
    const artworkId = params.get('id');

    const form = document.getElementById('artworkForm');
    const imageFileInput = document.getElementById('imageFile');
    const previewImage = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('imagePreviewContainer');

    let existingArtwork = null;

    // Load existing artwork if in edit mode
    if (artworkId) {
      document.getElementById('formTitle').textContent = 'Edit Artwork';

      fetch(`${API_URL}/artwork/${artworkId}`)
        .then(res => res.json())
        .then(data => {
          existingArtwork = data;

          document.getElementById('title').value = data.title;
          document.getElementById('artist').value = data.artist;
          document.getElementById('medium').value = data.medium;
          document.getElementById('year').value = data.year;

          // Show existing image preview
          previewImage.src = `data:${data.imageType};base64,${data.imageData}`;
          previewContainer.style.display = 'block';
        });
    }

    // New image preview on selection
    imageFileInput.addEventListener('change', () => {
      const file = imageFileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else if (existingArtwork) {
        previewImage.src = `data:${existingArtwork.imageType};base64,${existingArtwork.imageData}`;
      }
    });

    form.onsubmit = async (e) => {
      e.preventDefault();

      const formData = new FormData();
      const artworkJson = {
        title: document.getElementById('title').value,
        artist: document.getElementById('artist').value,
        medium: document.getElementById('medium').value,
        year: document.getElementById('year').value
      };

      formData.append('artwork', new Blob([JSON.stringify(artworkJson)], { type: 'application/json' }));

      // Append image only if user selected one, else add existing base64 image data manually
      if (imageFileInput.files.length > 0) {
        formData.append('imageFile', imageFileInput.files[0]);
      } else if (artworkId && existingArtwork) {
        // Send fallback image manually (base64 as byte[] in backend)
        const byteArray = Uint8Array.from(atob(existingArtwork.imageData), c => c.charCodeAt(0));
        const blob = new Blob([byteArray], { type: existingArtwork.imageType });
        formData.append('imageFile', blob, existingArtwork.imageName);
      }

      const res = await fetch(artworkId ? `${API_URL}/artwork/${artworkId}` : `${API_URL}/artwork`, {
        method: artworkId ? 'PUT' : 'POST',
        body: formData
      });

      if (res.ok) {
        alert('Artwork saved successfully!');
        window.location.href = 'gallery.html';
      } else {
        alert('Failed to save artwork');
      }
    };
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
